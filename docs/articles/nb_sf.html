<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Creating Neighbours using sf objects • spdep</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Creating Neighbours using sf objects">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spdep</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3-6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/CO69.html">“The Problem of Spatial Autocorrelation:” forty years on</a></li>
    <li><a class="dropdown-item" href="../articles/nb_sf.html">Creating Neighbours using sf objects</a></li>
    <li><a class="dropdown-item" href="../articles/nb.html">Creating Neighbours</a></li>
    <li><a class="dropdown-item" href="../articles/sids.html">Introduction to the North Carolina SIDS data set (re-revised)</a></li>
    <li><a class="dropdown-item" href="../articles/subgraphs.html">No-neighbour observation and subgraph handling</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-spatial/spdep/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Creating Neighbours using sf objects</h1>
                        <h4 data-toc-skip class="author">Roger
Bivand</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-spatial/spdep/blob/HEAD/vignettes/nb_sf.Rmd" class="external-link"><code>vignettes/nb_sf.Rmd</code></a></small>
      <div class="d-none name"><code>nb_sf.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="creating-neighbours-using-sf-objects">Creating Neighbours using sf objects<a class="anchor" aria-label="anchor" href="#creating-neighbours-using-sf-objects"></a>
</h2>
<div class="section level3">
<h3 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h3>
<p>This vignette tracks the legacy nb vignette, which was based on part
of the first (2008) edition of ASDAR. It adds hints to the code in the
nb vignette to use the sf vector representation instead of the sp vector
representation to create neighbour objects. .</p>
</div>
<div class="section level3">
<h3 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h3>
<p>This is a summary of the results below:</p>
<ul>
<li><p>In general, if you need to reproduce results from using
<code>"Spatial"</code> objects in <strong>spdep</strong>, coerce sf
objects to sp objects before constructing neighbour objects
(particularly if polygon centroids are used for point
representation).</p></li>
<li><p>However, for new work, you should use <code>"sf"</code> objects
read in using <strong>sf</strong>.</p></li>
<li><p>From <strong>spdep</strong> 1.1-7, a number of steps have been
taken to choose more efficient approaches especially for larger data
sets, using functions in <strong>sf</strong> and the approximate nearest
neighbour (ANN) implementation in <strong>dbscan</strong> rather than
<strong>RANN</strong>.</p></li>
</ul>
</div>
<div class="section level3">
<h3 id="data-set">Data set<a class="anchor" aria-label="anchor" href="#data-set"></a>
</h3>
<p>We’ll use the whole NY 8 county set of boundaries, as they challenge
the implementations more than just the Syracuse subset. The description
of the input geometries from ADSAR is: New York leukemia: used and
documented extensively in Waller and Gotway (2004) and with data
formerly made available in Chap. 9 of
<code>http://web1.sph.emory.edu/users/lwaller/ch9index.htm</code>; the
data import process is described in the help file of NY_data in
<strong>spData</strong>; geometries downloaded from the CIESIN server at
<a href="https://sedac.ciesin.columbia.edu/data/set/acrp-boundary-1992/data-download" class="external-link">https://sedac.ciesin.columbia.edu/data/set/acrp-boundary-1992/data-download</a>,
file /pub/census/usa/tiger/ny/bna_st/t8_36.zip, and extensively edited;
a zip archive NY_data.zip of shapefiles and a GAL format neighbours list
is on the book website. Further, the zipfile is now at a new location
requiring login. The object listw_NY is directly imported from
nyadjwts.dbf on the Waller &amp; Gotway (2004) chapter 9 website.</p>
<p>The version of the New York 8 counties geometries used in ASDAR and
included as a shapefile in spdep was converted from the original BNA
file using an external utility program to convert to MapInfo format and
converted on from there using GDAL 1.4.1 (the OGR BNA driver was not
then available; it entered OGR at 1.5.0, release at the end of 2007),
and contains invalid geometries. What was found in mid-2007 was that
included villages were in/excluded by in-out umbilical cords to the
boundary of the enclosing tract, when the underlying BNA file was first
converted to MapInfo (holes could not exist then).</p>
<p>Here we will use a GPKG file created as follows (rgdal could also be
used with the same output; GDAL prior to GDAL 3.3 built with GEOS, so
the BNA vector driver will use geometry tests: The BNA driver supports
reading of polygons with holes or lakes. It determines what is a hole or
a lake only from geometrical analysis (inclusion, non-intersection
tests) and ignores completely the notion of polygon winding (whether the
polygon edges are described clockwise or counter-clockwise). GDAL must
be built with GEOS enabled to make geometry test work.):</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span><span class="op">)</span></span>
<span><span class="va">sf_bna</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="st">"t8_36.bna"</span>, stringsAsFactors<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_is_valid</a></span><span class="op">(</span><span class="va">sf_bna</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">sf_bna</span><span class="op">$</span><span class="va">AREAKEY</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">gsub</a></span><span class="op">(</span><span class="st">"\\."</span>, <span class="st">""</span>, <span class="va">sf_bna</span><span class="op">$</span><span class="va">Primary.ID</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">NY_data</span>, package<span class="op">=</span><span class="st">"spData"</span><span class="op">)</span></span>
<span><span class="va">key</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">nydata</span><span class="op">$</span><span class="va">AREAKEY</span><span class="op">)</span></span>
<span><span class="va">sf_bna1</span> <span class="op">&lt;-</span> <span class="va">sf_bna</span><span class="op">[</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">key</span>, <span class="va">sf_bna</span><span class="op">$</span><span class="va">AREAKEY</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AREAKEY"</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">sf_bna2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">sf_bna1</span>, <span class="va">nydata</span>, by<span class="op">=</span><span class="st">"AREAKEY"</span><span class="op">)</span></span>
<span><span class="va">sf_bna2_utm18</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">sf_bna2</span>, <span class="st">"+proj=utm +zone=18 +datum=NAD27"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html" class="external-link">st_write</a></span><span class="op">(</span><span class="va">sf_bna2_utm18</span>, <span class="st">"NY8_bna_utm18.gpkg"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="nb-and-listw-objects-copied-from-the-nb_igraph-vignette">nb and listw objects (copied from the nb_igraph vignette)<a class="anchor" aria-label="anchor" href="#nb-and-listw-objects-copied-from-the-nb_igraph-vignette"></a>
</h3>
<p>Since the <strong>spdep</strong> package was created, <em>spatial
weights</em> objects have been constructed as lists with three
components and a few attributes, in old-style class <code>listw</code>
objects. The first component of a <code>listw</code> object is an
<code>nb</code> object, a list of <code>n</code> integer vectors, with
at least a character vector <code>region.id</code> attribute with
<code>n</code> unique values (like the <code>row.names</code> of a
<code>data.frame</code> object); <code>n</code> is the number of spatial
entities. Component <code>i</code> of this list contains the integer
identifiers of the neighbours of <code>i</code> as a sorted vector with
no duplication and values in <code>1:n</code>; if <code>i</code> has no
neighbours, the component is a vector of length <code>1</code> with
value <code>0L</code>. The <code>nb</code> object may contain an
attribute indicating whether it is symmetric or not, that is whether
<code>i</code> is a neighbour of <code>j</code> implies that
<code>j</code> is a neighbour of <code>i</code>. Some neighbour
definitions are symmetric by construction, such as contiguities or
distance thresholds, others are asymmetric, such as
<code>k</code>-nearest neighbours. The <code>nb</code> object
redundantly stores both <code>i</code>-<code>j</code> and
<code>j</code>-<code>i</code> links.</p>
<p>The second component of a <code>listw</code> object is a list of
<code>n</code> numeric vectors, each of the same length as the
corresponding non-zero vectors in the <code>nb</code>object. These give
the values of the spatial weights for each <code>i</code>-<code>j</code>
neighbour pair. It is often the case that while the neighbours are
symmetric by construction, the weights are not, as for example when
weights are <em>row-standardised</em> by dividing each row of input
weights by the count of neighbours or cardinality of the neighbour set
of <code>i</code>. In the <code>nb2listw</code>function, it is also
possible to pass through general weights, such as inverse distances,
shares of boundary lengths and so on.</p>
<p>The third component of a <code>listw</code> object records the
<code>style</code> of the weights as a character code, with
<code>"B"</code> for binary weights taking values zero or one (only one
is recorded), <code>"W"</code> for row-standardised weights, and so on.
In order to subset <code>listw</code> objects, knowledge of the
<code>style</code> may be necessary.</p>
</div>
<div class="section level3">
<h3 id="comparison-of-sp-and-sf-approaches">Comparison of sp and sf approaches<a class="anchor" aria-label="anchor" href="#comparison-of-sp-and-sf-approaches"></a>
</h3>
<p>First some housekeeping and setup to permit this vignette to be built
when packages are missing or out-of-date:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/" class="external-link">sf</a></span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"install the sf package"</span><span class="op">)</span></span>
<span>  <span class="va">dothis</span> <span class="op">&lt;-</span> <span class="cn">FALSE</span></span>
<span><span class="op">}</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">dothis</span><span class="op">)</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf_extSoftVersion.html" class="external-link">sf_extSoftVersion</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           GEOS           GDAL         proj.4 GDAL_with_GEOS     USE_PROJ_H </span></span>
<span><span class="co">##       "3.13.0"        "3.9.2"        "9.5.0"         "true"         "true" </span></span>
<span><span class="co">##           PROJ </span></span>
<span><span class="co">##        "9.5.0"</span></span></code></pre>
<p>Let us read the GPKG file with valid geometries in to ‘sf’ and ‘sp’
objects:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NY8_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shapes/NY8_bna_utm18.gpkg"</span>, package<span class="op">=</span><span class="st">"spData"</span><span class="op">)</span>, quiet<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_is_valid</a></span><span class="op">(</span><span class="va">NY8_sf</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## TRUE </span></span>
<span><span class="co">##  281</span></span></code></pre>
<div class="section level4">
<h4 id="contiguity-neighbours-for-polygon-support">Contiguity neighbours for polygon support<a class="anchor" aria-label="anchor" href="#contiguity-neighbours-for-polygon-support"></a>
</h4>
<p>Here we first generate a queen contiguity nb object using the legacy
spdep approach. This first either uses a pre-computed list of vectors of
probable neighbours or finds intersecting bounding boxes internally.
Then the points on the boundaries of each set of polygons making up an
observation are checked for a distance less than snap to any of the
points of the set of polygons making up an observation included in the
set of candidate neighbours. Because contiguity is symmetric, only i to
j contiguities are tested. A queen contiguity is found as soon as one
point matches, a rook contiguity as soon as two points match:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/" class="external-link">spdep</a></span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">reps</span> <span class="op">&lt;-</span> <span class="fl">10</span></span>
<span><span class="va">eps</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">.Machine</span><span class="op">$</span><span class="va">double.eps</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span> <span class="va">NY8_sf_1_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">NY8_sf</span>, queen<span class="op">=</span><span class="cn">TRUE</span>, snap<span class="op">=</span><span class="va">eps</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">reps</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.1847  0.0088  0.1943</span></span></code></pre>
<p>Using spatial indices to check intersection of polygons is much
faster than the legacy method in poly2nb. From <strong>spdep</strong>
1.1-7, use is made of GEOS through <strong>sf</strong> to find candidate
neighbours when <code>foundInBox=NULL</code>, the default value. Because
contiguity is symmetric by definition, <code>foundInBox=</code> only
requires intersections for higher indices, leading to a slight overhead
to remove duplicates, as <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_intersects()</a></code> reports both
<code>i j</code> ans <code>j i</code> relationships. As
<code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_intersects()</a></code> does not report whether neighbours are
<code>queen</code> or <code>rook</code>, a further step is needed to
distinguish the two cases.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NY8_sf_1_nb</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 281 </span></span>
<span><span class="co">## Number of nonzero links: 1632 </span></span>
<span><span class="co">## Percentage nonzero weights: 2.066843 </span></span>
<span><span class="co">## Average number of links: 5.807829</span></span></code></pre>
<p>spdep::poly2nb uses two heuristics, first to find candidate
neighbours from intersecting polygons (<code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_intersects()</a></code>),
and second to use the symmetry of the relationship to halve the number
of remaining tests. This means that performance is linear in n, but with
overhead for identifying candidates, and back-filling symmetric
neighbours. Further, <code><a href="../reference/poly2nb.html">spdep::poly2nb()</a></code> stops searching for
queen contiguity as soon as the first neighbour point is found within
snap distance (if not identical, which is tested first); a second
neighbour point indicates rook contiguities. For details of alternatives
for spherical geometries, see section @ref(spher-poly2nb) below.</p>
</div>
<div class="section level4">
<h4 id="contiguity-neighbours-from-invalid-polygons">Contiguity neighbours from invalid polygons<a class="anchor" aria-label="anchor" href="#contiguity-neighbours-from-invalid-polygons"></a>
</h4>
<p>Next, we explore a further possible source of differences in
neighbour object reproduction, using the original version of the tract
boundaries used in ASDAR, but with some invalid geometries as mentioned
earlier (<code>NY8_utm18.gpkg</code> was created from the original ESRI
Shapefile used in ASDAR):</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"spData"</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="st">"2.3.2"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">NY8_sf_old</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shapes/NY8_utm18.gpkg"</span>, package<span class="op">=</span><span class="st">"spData"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">NY8_sf_old</span> <span class="op">&lt;-</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"shapes/NY8_utm18.shp"</span>, package<span class="op">=</span><span class="st">"spData"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Reading layer `NY8_utm18' from data source </span></span>
<span><span class="co">##   `/home/rsb/lib/r_libs/spData/shapes/NY8_utm18.gpkg' using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 281 features and 17 fields</span></span>
<span><span class="co">## Geometry type: POLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 358241.9 ymin: 4649755 xmax: 480393.1 ymax: 4808545</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 18N</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_is_valid</a></span><span class="op">(</span><span class="va">NY8_sf_old</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## FALSE  TRUE </span></span>
<span><span class="co">##     5   276</span></span></code></pre>
<p>We can see that there are a number of differences between the
neighbour sets derived from the fully valid geometries and the older
partly invalid set:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">NY8_sf_old_1_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">NY8_sf_old</span><span class="op">)</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">NY8_sf_old_1_nb</span>, <span class="va">NY8_sf_1_nb</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Component 57: Numeric: lengths (4, 5) differ" </span></span>
<span><span class="co">## [2] "Component 58: Numeric: lengths (5, 6) differ" </span></span>
<span><span class="co">## [3] "Component 66: Numeric: lengths (7, 11) differ"</span></span>
<span><span class="co">## [4] "Component 73: Numeric: lengths (4, 5) differ" </span></span>
<span><span class="co">## [5] "Component 260: Numeric: lengths (8, 9) differ"</span></span></code></pre>
<p>Using <code><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid()</a></code> to make the geometries valid:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NY8_sf_old_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="va">NY8_sf_old</span>, dist<span class="op">=</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_is_valid</a></span><span class="op">(</span><span class="va">NY8_sf_old_val</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## TRUE </span></span>
<span><span class="co">##  281</span></span></code></pre>
<p>we also see that the geometry type of the geometry column
changes:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">NY8_sf_old</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "sfc_POLYGON" "sfc"</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">NY8_sf_old_val</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "sfc_GEOMETRY" "sfc"</span></span></code></pre>
<p>and checking the <code>"sfg"</code> objects, two now have objects of
different topological dimensions.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">NY8_sf_old_val</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## MULTIPOLYGON      POLYGON </span></span>
<span><span class="co">##            3          278</span></span></code></pre>
<p>This can be remedied using <code><a href="https://r-spatial.github.io/sf/reference/st_collection_extract.html" class="external-link">st_collection_extract()</a></code> to
get the polygon objects:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NY8_sf_old_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_collection_extract.html" class="external-link">st_collection_extract</a></span><span class="op">(</span><span class="va">NY8_sf_old_val</span>, <span class="st">"POLYGON"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">NY8_sf_old_val</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## MULTIPOLYGON </span></span>
<span><span class="co">##          281</span></span></code></pre>
<p>However, in making the geometries valid, we change the geometries, so
the new sets of neighbours still differ from those made with the valid
geometries in the same ways as before imposing validity:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="va">NY8_sf_old_1_nb_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">NY8_sf_old_val</span><span class="op">)</span>, silent <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">NY8_sf_old_1_nb_val</span>, <span class="va">NY8_sf_1_nb</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Component 57: Numeric: lengths (4, 5) differ" </span></span>
<span><span class="co">## [2] "Component 58: Numeric: lengths (5, 6) differ" </span></span>
<span><span class="co">## [3] "Component 66: Numeric: lengths (7, 11) differ"</span></span>
<span><span class="co">## [4] "Component 73: Numeric: lengths (4, 5) differ" </span></span>
<span><span class="co">## [5] "Component 260: Numeric: lengths (8, 9) differ"</span></span></code></pre>
<p>The neighbour sets are the same for the old boundaries with or
without imposing validity:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">NY8_sf_old_1_nb_val</span>, <span class="va">NY8_sf_old_1_nb</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="planar-point-based-neighbours">Planar point-based neighbours<a class="anchor" aria-label="anchor" href="#planar-point-based-neighbours"></a>
</h3>
<div class="section level4">
<h4 id="finding-points-for-polygon-objects">Finding points for polygon objects<a class="anchor" aria-label="anchor" href="#finding-points-for-polygon-objects"></a>
</h4>
<p><code><a href="../reference/knearneigh.html">knearneigh()</a></code> and <code><a href="../reference/dnearneigh.html">dnearneigh()</a></code> require point
support, so decisions must be taken about how to place the point in the
areal object. We can use <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid()</a></code> to get the
centroids, using the <code>of_largest_polygon=TRUE</code> argument to
make sure that the centroid is that of the largest polygon id the
observation is made up of more than one external ring:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NY8_ct_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_centroid</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">NY8_sf</span><span class="op">)</span>, of_largest_polygon<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>or <code><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_point_on_surface()</a></code> which guarantees that the point
will fall on the surface of a member polygon:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NY8_pos_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_point_on_surface</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">NY8_sf</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>or indeed taking the centre of the largest inscribed circle (the
function returns a radius line segment, so we choose the central point,
not the point on the circle):</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf_extSoftVersion.html" class="external-link">sf_extSoftVersion</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="st">"GEOS"</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="st">"3.9.0"</span><span class="op">)</span><span class="op">)</span> </span>
<span>    <span class="va">NY8_cic_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_cast.html" class="external-link">st_cast</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_inscribed_circle</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">NY8_sf</span><span class="op">)</span>, nQuadSegs<span class="op">=</span><span class="fl">0</span><span class="op">)</span>, <span class="st">"POINT"</span><span class="op">)</span><span class="op">[</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="fl">2</span><span class="op">*</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/dimensions.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">NY8_sf</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/Arithmetic.html" class="external-link">%%</a></span> <span class="fl">2</span><span class="op">)</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span></span></code></pre></div>
<p>We need to check whether coordinates are planar or not:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_is_longlat.html" class="external-link">st_is_longlat</a></span><span class="op">(</span><span class="va">NY8_ct_sf</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="graph-based-neighbours">Graph-based neighbours<a class="anchor" aria-label="anchor" href="#graph-based-neighbours"></a>
</h4>
<p>From this, we can check the graph-based neighbours (planar
coordinates only):</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">suppressPackageStartupMessages</a></span><span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va">deldir</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">NY84_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/tri2nb.html">tri2nb</a></span><span class="op">(</span><span class="va">NY8_ct_sf</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/mhahsler/dbscan" class="external-link">dbscan</a></span>, quietly<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">NY85_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graphneigh.html">graph2nb</a></span><span class="op">(</span><span class="fu"><a href="../reference/graphneigh.html">soi.graph</a></span><span class="op">(</span><span class="va">NY84_nb</span>, <span class="va">NY8_ct_sf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="va">NY85_nb</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'dbscan'</span></span></code></pre>
<pre><code><span><span class="co">## The following object is masked from 'package:stats':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     as.dendrogram</span></span></code></pre>
<pre><code><span><span class="co">## Warning in graph2nb(soi.graph(NY84_nb, NY8_ct_sf)): neighbour object has 2</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NY86_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graphneigh.html">graph2nb</a></span><span class="op">(</span><span class="fu"><a href="../reference/graphneigh.html">gabrielneigh</a></span><span class="op">(</span><span class="va">NY8_ct_sf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">NY87_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/graphneigh.html">graph2nb</a></span><span class="op">(</span><span class="fu"><a href="../reference/graphneigh.html">relativeneigh</a></span><span class="op">(</span><span class="va">NY8_ct_sf</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="k-nearest-neighbours">K-nearest neighbours<a class="anchor" aria-label="anchor" href="#k-nearest-neighbours"></a>
</h4>
<p>K-nearest neighbours use the coordinate matrices, and can handle
Great Circle distances, but this is not demonstrated here, as the data
set used is planar, in which case <code><a href="https://rdrr.io/pkg/dbscan/man/kNN.html" class="external-link">dbscan::kNN()</a></code> in 2D or 3D
building a kd-tree is used:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">NY88_nb_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="fu"><a href="../reference/knearneigh.html">knearneigh</a></span><span class="op">(</span><span class="va">NY8_ct_sf</span>, k<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">reps</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.0224  0.0009  0.0234</span></span></code></pre>
<p>Legacy code may be used omitting the kd-tree:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">NY89_nb_sf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="fu"><a href="../reference/knearneigh.html">knearneigh</a></span><span class="op">(</span><span class="va">NY8_ct_sf</span>, k<span class="op">=</span><span class="fl">1</span>, use_kd_tree<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">reps</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.0239  0.0007  0.0247</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="distance-neighbours">Distance neighbours<a class="anchor" aria-label="anchor" href="#distance-neighbours"></a>
</h4>
<p>Distance neighbours need a threshold - <code>nbdists</code> shows the
maximum distance to first nearest neighbour:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dsts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="../reference/nbdists.html">nbdists</a></span><span class="op">(</span><span class="va">NY88_nb_sf</span>, <span class="va">NY8_ct_sf</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">dsts</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##     Min.  1st Qu.   Median     Mean  3rd Qu.     Max. </span></span>
<span><span class="co">##    82.85   912.85  1801.11  3441.04  4461.26 17033.11</span></span></code></pre>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">max_1nn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">dsts</span><span class="op">)</span></span></code></pre></div>
<p><code>dnearneigh</code> can also handle Great Circle distances, but
this is not demonstrated here, as the data set used is planar:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">NY810_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="va">NY8_ct_sf</span>, d1<span class="op">=</span><span class="fl">0</span>, d2<span class="op">=</span><span class="fl">0.75</span><span class="op">*</span><span class="va">max_1nn</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">reps</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.0583  0.0018  0.0603</span></span></code></pre>
<p>By default, the function uses <code><a href="https://rdrr.io/pkg/dbscan/man/frNN.html" class="external-link">dbscan::frNN()</a></code> to build a
kd-tree in 2D or 3D which is then used to find distance neighbours. For
small n, the argument <code>use_kd_tree=FALSE</code> may speed up
computation a little by reverting to legacy code not building a kd-tree
first, but in general the differences are so small that the user will
not notice:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">NY811_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="va">NY8_ct_sf</span>, d1<span class="op">=</span><span class="fl">0</span>, d2<span class="op">=</span><span class="fl">0.75</span><span class="op">*</span><span class="va">max_1nn</span>, use_kd_tree<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">reps</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.0445  0.0012  0.0458</span></span></code></pre>
</div>
</div>
<div class="section level3">
<h3 id="spherical-point-based-neighbours">Spherical point-based neighbours<a class="anchor" aria-label="anchor" href="#spherical-point-based-neighbours"></a>
</h3>
<p>Spherical point-based neighbours may be found using Great Circle
distances. These have been used for many years, but the switch of
<strong>sf</strong> 1.0-0 to use <strong>s2</strong> by default has
opened up new opportunities where spatial indexing on the sphere may
help.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pts_ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">NY8_ct_sf</span>, <span class="st">"OGC:CRS84"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_is_longlat.html" class="external-link">st_is_longlat</a></span><span class="op">(</span><span class="va">pts_ll</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="section level4">
<h4 id="k-nearest-neighbours-1">K-nearest neighbours<a class="anchor" aria-label="anchor" href="#k-nearest-neighbours-1"></a>
</h4>
<p>If the input geometries are in geographical coordinates, and
<code><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2()</a></code> is <code>TRUE</code>, <code><a href="../reference/knearneigh.html">knearneigh()</a></code>
will use spatially indexed points and
<code><a href="https://r-spatial.github.io/s2/reference/s2_closest_feature.html" class="external-link">s2::s2_closest_edges()</a></code> (see <a href="https://github.com/r-spatial/s2/issues/125#issuecomment-860107442" class="external-link uri">https://github.com/r-spatial/s2/issues/125#issuecomment-860107442</a>)</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">old_use_s2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>and performs well with also with larger data sets:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span> <span class="va">pts_ll1_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="fu"><a href="../reference/knearneigh.html">knearneigh</a></span><span class="op">(</span><span class="va">pts_ll</span>, k<span class="op">=</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">reps</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.0319  0.0000  0.0320</span></span></code></pre>
<p>For this smaller data set, the legacy approach without spatial
indexing is adequate, but slows down as the number of observations
increases:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Spherical geometry (s2) switched off</span></span></code></pre>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span> <span class="va">pts_ll2_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="fu"><a href="../reference/knearneigh.html">knearneigh</a></span><span class="op">(</span><span class="va">pts_ll</span>, k<span class="op">=</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">reps</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.0296  0.0001  0.0298</span></span></code></pre>
<p>The WGS84 ellipsoid Great Circle distances differ a very little from
the <strong>s2</strong> spherical distances, yielding output that here
diverges for two tract centroids:</p>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">pts_ll1_nb</span>, <span class="va">pts_ll2_nb</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Component 52: Mean relative difference: 1.466667"  </span></span>
<span><span class="co">## [2] "Component 124: Mean relative difference: 0.0251046"</span></span></code></pre>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pts_ll1_nb</span><span class="op">[[</span><span class="fl">52</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 15 38 48 49 50 53</span></span></code></pre>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pts_ll2_nb</span><span class="op">[[</span><span class="fl">52</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 37 38 48 49 50 53</span></span></code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pts_ll1_nb</span><span class="op">[[</span><span class="fl">124</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 117 122 123 125 133 134</span></span></code></pre>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pts_ll2_nb</span><span class="op">[[</span><span class="fl">124</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 116 117 123 125 133 134</span></span></code></pre>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="va">old_use_s2</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Spherical geometry (s2) switched on</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="distance-neighbours-1">Distance neighbours<a class="anchor" aria-label="anchor" href="#distance-neighbours-1"></a>
</h4>
<p>Distance neighbours are more problematic. While
<code><a href="../reference/nbdists.html">nbdists()</a></code> works well with <strong>s2</strong> spherical
coordinates, none of the tried adaptations for <code><a href="../reference/dnearneigh.html">dnearneigh()</a></code>
work adequately yet. An argument <code>use_s2=</code> is set to TRUE if
<strong>s2</strong> &gt; 1.0-7, using
<code><a href="https://r-spatial.github.io/s2/reference/s2_closest_feature.html" class="external-link">s2::s2_closest_edges()</a></code> or the legacy brute-force approach,
then only calculating distances from <code>i</code> to <code>j</code>
and copying those to <code>j</code> to <code>i</code> through symmetry.
The distance metric is alway <code>"km"</code>.</p>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">max_1nn_ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="../reference/nbdists.html">nbdists</a></span><span class="op">(</span><span class="fu"><a href="../reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="fu"><a href="../reference/knearneigh.html">knearneigh</a></span><span class="op">(</span><span class="va">pts_ll</span>, k<span class="op">=</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span>, <span class="va">pts_ll</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in knn2nb(knearneigh(pts_ll, k = 1)): neighbour object has 62</span></span>
<span><span class="co">## sub-graphs</span></span></code></pre>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html" class="external-link">args</a></span><span class="op">(</span><span class="va">dnearneigh</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## function (x, d1, d2, row.names = NULL, longlat = NULL, bounds = c("GE", </span></span>
<span><span class="co">##     "LE"), use_kd_tree = TRUE, symtest = FALSE, use_s2 = packageVersion("s2") &gt; </span></span>
<span><span class="co">##     "1.0.7", k = 200, dwithin = TRUE) </span></span>
<span><span class="co">## NULL</span></span></code></pre>
<p>If we permit <strong>s2</strong> methods to run, without other
arguments set, and <strong>s2</strong> &gt; 1.0-7,
<code><a href="https://r-spatial.github.io/s2/reference/s2_closest_feature.html" class="external-link">s2::s2_dwithin_matrix()</a></code> is run:</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"s2"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="st">"1.0.7"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">reps</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">pts_ll3_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="va">pts_ll</span>, d1<span class="op">=</span><span class="fl">0</span>,</span>
<span>      d2<span class="op">=</span><span class="fl">0.75</span><span class="op">*</span><span class="va">max_1nn_ll</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">reps</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.0655  0.0000  0.0660</span></span></code></pre>
<p>Alternatively, spherical distances can be used with
<code>dwithin=FALSE</code> and <code><a href="https://r-spatial.github.io/s2/reference/s2_closest_feature.html" class="external-link">s2::s2_closest_edges()</a></code>;
although running in similar time, <code><a href="https://r-spatial.github.io/s2/reference/s2_closest_feature.html" class="external-link">s2::s2_closest_edges()</a></code>
depends on the additional <code>k=</code> argument, which, if mis-set,
may miss valid neighbours:</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">reps</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">pts_ll5_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="va">pts_ll</span>, d1<span class="op">=</span><span class="fl">0</span>, d2<span class="op">=</span><span class="fl">0.75</span><span class="op">*</span><span class="va">max_1nn_ll</span>, dwithin<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">reps</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.0525  0.0000  0.0525</span></span></code></pre>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"s2"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="st">"1.0.7"</span><span class="op">)</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">pts_ll3_nb</span>, <span class="va">pts_ll5_nb</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>Using <code><a href="https://r-spatial.github.io/s2/reference/s2_closest_feature.html" class="external-link">s2::s2_closest_edges()</a></code> respects
<code>d1 &gt; 0</code> without requiring a second pass in R, so is
faster than <code><a href="https://r-spatial.github.io/s2/reference/s2_closest_feature.html" class="external-link">s2::s2_dwithin_matrix()</a></code>:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"s2"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="st">"1.0.7"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">reps</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">pts_ll3a_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="va">pts_ll</span>, d1<span class="op">=</span><span class="fl">5</span>,</span>
<span>      d2<span class="op">=</span><span class="fl">0.75</span><span class="op">*</span><span class="va">max_1nn_ll</span>, dwithin<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">reps</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.0445  0.0000  0.0450</span></span></code></pre>
<p>Using <code><a href="https://r-spatial.github.io/s2/reference/s2_closest_feature.html" class="external-link">s2::s2_dwithin_matrix()</a></code> requires a second pass,
one for the lower bound, another for the upper bound, and a set
difference operation to find neighbours in the distance band:</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"s2"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="st">"1.0.7"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="op">(</span><span class="va">reps</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">pts_ll5a_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="va">pts_ll</span>, d1<span class="op">=</span><span class="fl">5</span>,</span>
<span>        d2<span class="op">=</span><span class="fl">0.75</span><span class="op">*</span><span class="va">max_1nn_ll</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">reps</span><span class="op">/</span><span class="fl">5</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##    0.09    0.00    0.09</span></span></code></pre>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"s2"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="st">"1.0.7"</span><span class="op">)</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">pts_ll3a_nb</span>, <span class="va">pts_ll5a_nb</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>Setting <code>use_s2=FALSE</code> falls back to the legacy version,
which uses symmetry to reduce time:</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">pts_ll6_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="va">pts_ll</span>, d1<span class="op">=</span><span class="fl">0</span>, d2<span class="op">=</span><span class="fl">0.75</span><span class="op">*</span><span class="va">max_1nn_ll</span>, use_s2<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">reps</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.0400  0.0000  0.0401</span></span></code></pre>
<p>Minor differences may occur between the legacy ellipsoid and
<strong>s2</strong> spherical approaches:</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">pts_ll5_nb</span>, <span class="va">pts_ll6_nb</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "Component 20: Numeric: lengths (6, 5) differ"     </span></span>
<span><span class="co">##  [2] "Component 28: Numeric: lengths (7, 6) differ"     </span></span>
<span><span class="co">##  [3] "Component 112: Numeric: lengths (109, 108) differ"</span></span>
<span><span class="co">##  [4] "Component 116: Numeric: lengths (109, 108) differ"</span></span>
<span><span class="co">##  [5] "Component 122: Numeric: lengths (105, 106) differ"</span></span>
<span><span class="co">##  [6] "Component 123: Numeric: lengths (108, 107) differ"</span></span>
<span><span class="co">##  [7] "Component 130: Numeric: lengths (108, 109) differ"</span></span>
<span><span class="co">##  [8] "Component 134: Numeric: lengths (106, 105) differ"</span></span>
<span><span class="co">##  [9] "Component 158: Numeric: lengths (101, 102) differ"</span></span>
<span><span class="co">## [10] "Component 165: Numeric: lengths (101, 102) differ"</span></span>
<span><span class="co">## [11] "Component 168: Numeric: lengths (101, 102) differ"</span></span>
<span><span class="co">## [12] "Component 179: Numeric: lengths (89, 90) differ"  </span></span>
<span><span class="co">## [13] "Component 180: Numeric: lengths (96, 97) differ"  </span></span>
<span><span class="co">## [14] "Component 188: Numeric: lengths (46, 47) differ"  </span></span>
<span><span class="co">## [15] "Component 189: Numeric: lengths (55, 56) differ"  </span></span>
<span><span class="co">## [16] "Component 196: Numeric: lengths (47, 46) differ"  </span></span>
<span><span class="co">## [17] "Component 210: Numeric: lengths (106, 104) differ"</span></span>
<span><span class="co">## [18] "Component 226: Numeric: lengths (88, 87) differ"  </span></span>
<span><span class="co">## [19] "Component 229: Numeric: lengths (55, 53) differ"  </span></span>
<span><span class="co">## [20] "Component 235: Numeric: lengths (40, 39) differ"  </span></span>
<span><span class="co">## [21] "Component 237: Numeric: lengths (14, 15) differ"  </span></span>
<span><span class="co">## [22] "Component 245: Numeric: lengths (16, 15) differ"</span></span></code></pre>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html" class="external-link">suppressWarnings</a></span><span class="op">(</span><span class="va">pts_ll6a_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dnearneigh.html">dnearneigh</a></span><span class="op">(</span><span class="va">pts_ll</span>, d1<span class="op">=</span><span class="fl">5</span>, d2<span class="op">=</span><span class="fl">0.75</span><span class="op">*</span><span class="va">max_1nn_ll</span>, use_s2<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">reps</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.0310  0.0001  0.0313</span></span></code></pre>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/packageDescription.html" class="external-link">packageVersion</a></span><span class="op">(</span><span class="st">"s2"</span><span class="op">)</span> <span class="op">&gt;</span> <span class="st">"1.0.7"</span><span class="op">)</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">pts_ll5a_nb</span>, <span class="va">pts_ll6a_nb</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  [1] "Component 20: Numeric: lengths (6, 5) differ"       </span></span>
<span><span class="co">##  [2] "Component 28: Numeric: lengths (7, 6) differ"       </span></span>
<span><span class="co">##  [3] "Component 112: Numeric: lengths (62, 61) differ"    </span></span>
<span><span class="co">##  [4] "Component 113: Numeric: lengths (62, 63) differ"    </span></span>
<span><span class="co">##  [5] "Component 116: Numeric: lengths (56, 55) differ"    </span></span>
<span><span class="co">##  [6] "Component 119: Numeric: lengths (68, 69) differ"    </span></span>
<span><span class="co">##  [7] "Component 122: Numeric: lengths (43, 44) differ"    </span></span>
<span><span class="co">##  [8] "Component 123: Numeric: lengths (50, 49) differ"    </span></span>
<span><span class="co">##  [9] "Component 128: Numeric: lengths (65, 64) differ"    </span></span>
<span><span class="co">## [10] "Component 130: Numeric: lengths (61, 63) differ"    </span></span>
<span><span class="co">## [11] "Component 132: Numeric: lengths (45, 46) differ"    </span></span>
<span><span class="co">## [12] "Component 134: Numeric: lengths (46, 45) differ"    </span></span>
<span><span class="co">## [13] "Component 136: Numeric: lengths (61, 62) differ"    </span></span>
<span><span class="co">## [14] "Component 147: Numeric: lengths (50, 51) differ"    </span></span>
<span><span class="co">## [15] "Component 154: Numeric: lengths (56, 57) differ"    </span></span>
<span><span class="co">## [16] "Component 158: Numeric: lengths (49, 50) differ"    </span></span>
<span><span class="co">## [17] "Component 165: Mean relative difference: 0.02823018"</span></span>
<span><span class="co">## [18] "Component 168: Numeric: lengths (54, 56) differ"    </span></span>
<span><span class="co">## [19] "Component 179: Numeric: lengths (77, 78) differ"    </span></span>
<span><span class="co">## [20] "Component 180: Numeric: lengths (85, 86) differ"    </span></span>
<span><span class="co">## [21] "Component 188: Numeric: lengths (39, 40) differ"    </span></span>
<span><span class="co">## [22] "Component 189: Numeric: lengths (48, 49) differ"    </span></span>
<span><span class="co">## [23] "Component 196: Numeric: lengths (45, 44) differ"    </span></span>
<span><span class="co">## [24] "Component 210: Numeric: lengths (68, 66) differ"    </span></span>
<span><span class="co">## [25] "Component 226: Numeric: lengths (82, 81) differ"    </span></span>
<span><span class="co">## [26] "Component 229: Numeric: lengths (48, 46) differ"    </span></span>
<span><span class="co">## [27] "Component 235: Numeric: lengths (38, 37) differ"    </span></span>
<span><span class="co">## [28] "Component 237: Numeric: lengths (14, 15) differ"    </span></span>
<span><span class="co">## [29] "Component 245: Numeric: lengths (15, 14) differ"</span></span></code></pre>
</div>
<div class="section level4">
<h4 id="spher-poly2nb">Contiguity neighbours for spherical polygon support<a class="anchor" aria-label="anchor" href="#spher-poly2nb"></a>
</h4>
<p>It also turns out that when <strong>sf</strong> functions are used to
find contiguity neighbours, <strong>s2</strong> spatial indexing
functionality is accessed in finding candidate neighbours in
intersecting geometries.</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">NY8_sf_ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">NY8_sf</span>, <span class="st">"OGC:CRS84"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_is_longlat.html" class="external-link">st_is_longlat</a></span><span class="op">(</span><span class="va">NY8_sf_ll</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>The timings are a little slower when <code><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html" class="external-link">st_intersects()</a></code>
hands off geometry predicates to <code>s2_intersects_matrix()</code>,
but the results are the same, and because spatial indexing is used, this
scales well for larger data sets:</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/s2.html" class="external-link">sf_use_s2</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">reps</span><span class="op">)</span> <span class="va">NY8_sf_1_nb_ll</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">NY8_sf_ll</span>, queen<span class="op">=</span><span class="cn">TRUE</span>, snap<span class="op">=</span><span class="va">eps</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="va">reps</span></span></code></pre></div>
<pre><code><span><span class="co">##    user  system elapsed </span></span>
<span><span class="co">##  0.1604  0.0024  0.1634</span></span></code></pre>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">NY8_sf_1_nb</span>, <span class="va">NY8_sf_1_nb_ll</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Roger Bivand.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
