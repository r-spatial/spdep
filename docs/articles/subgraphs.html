<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>No-neighbour observation and subgraph handling • spdep</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="No-neighbour observation and subgraph handling">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">spdep</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.3-6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/CO69.html">“The Problem of Spatial Autocorrelation:” forty years on</a></li>
    <li><a class="dropdown-item" href="../articles/nb_sf.html">Creating Neighbours using sf objects</a></li>
    <li><a class="dropdown-item" href="../articles/nb.html">Creating Neighbours</a></li>
    <li><a class="dropdown-item" href="../articles/sids.html">Introduction to the North Carolina SIDS data set (re-revised)</a></li>
    <li><a class="dropdown-item" href="../articles/subgraphs.html">No-neighbour observation and subgraph handling</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-spatial/spdep/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>No-neighbour observation and subgraph handling</h1>
                        <h4 data-toc-skip class="author">Roger
Bivand</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-spatial/spdep/blob/HEAD/vignettes/subgraphs.Rmd" class="external-link"><code>vignettes/subgraphs.Rmd</code></a></small>
      <div class="d-none name"><code>subgraphs.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>spdep</code> package has always been careful about
disconnected graphs, especially where the disconnected observations are
graph nodes with no neighbours, that is no incoming or outgoing edges.
In <code>nb</code> neighbour objects, they are encoded as integer
vectors of length 1 containing integer <code>0</code>, which is an
invalid index on
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mn>1</mn><mo>,</mo><mi>N</mi><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[1, N]</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
is the observation count. Functions taking neighbour objects as
arguments use the <code>zero.policy</code> argument to guide how to
handle no-neighbour observations.</p>
<p><code>spdep</code> has also had <code>n.comp.nb</code> to find the
number of disjoint connected subgraphs in an <code>nb</code> object,
contributed by Nicholas Lewin-Koh in 2001 and using depth-first search
for symmetric neighbours, showing in addition which observations belong
to which subgraph. Obviously, no-neighbour observations are singleton
graph nodes, but subgraphs are also troubling for spatial analysis,
because there is no connection between the spatial processes in those
subgraphs. The ripples in one pond cannot cross into a separate pond if
they are not connected.</p>
<p>From <code>spdep</code> 1.3-1, steps began to raise awareness of the
possibility that neighbour objects might be created that are
disconnected in some way, mostly through warnings, and through the
computation of subgraph measures by default. This vignette is intended
to provide some background to these steps.</p>
</div>
<div class="section level2">
<h2 id="no-neighbour-observations">No-neighbour observations<a class="anchor" aria-label="anchor" href="#no-neighbour-observations"></a>
</h2>
<p>From the start, <code>nb</code> objects have recorded no-neighbour
observations as an integer vector of unit length and value
<code>0</code>, where neighbours are recorded as ID values between
<code>1</code> and <code>N</code>, where <code>N</code> is the
observation count. <code>print</code> and <code>summary</code> methods
have always reported the presence of no-neighbour observations, and
listed their IDs (or <code>region.id</code> values). If an
<code>nb</code> object contains no-neighbour observations, the user has
to decide whether to drop those observations, or if retained, what value
to give its weights. The <code>zero.policy</code> argument uses zero as
the value if TRUE, but if FALSE causes <code>nb2listw</code> to fail.
The value of <code>zero.policy</code> in a call to functions like
<code>nb2listw</code>, <code>subset.listw</code> or
<code>mat2listw</code> creating <code>listw</code> objects representing
sparse spatial weights matrices is added to the created object as an
attribute, and used subsequently to pass through that choice to other
functions. For example, <code>moran.test</code> takes the value of this
attribute as default for its <code>zero.policy</code> argument:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/spdep/" class="external-link">spdep</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required package: spData</span></span></code></pre>
<pre><code><span><span class="co">## Loading required package: sf</span></span></code></pre>
<pre><code><span><span class="co">## Linking to GEOS 3.13.0, GDAL 3.9.2, PROJ 9.4.1; sf_use_s2() is TRUE</span></span></code></pre>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/args.html" class="external-link">args</a></span><span class="op">(</span><span class="va">moran.test</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## function (x, listw, randomisation = TRUE, zero.policy = attr(listw, </span></span>
<span><span class="co">##     "zero.policy"), alternative = "greater", rank = FALSE, na.action = na.fail, </span></span>
<span><span class="co">##     spChk = NULL, adjust.n = TRUE, drop.EI2 = FALSE) </span></span>
<span><span class="co">## NULL</span></span></code></pre>
<p>If observation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
has no neighbours, its weights sum
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msubsup><mo>∑</mo><mrow><mi>j</mi><mo>=</mo><mn>1</mn></mrow><mi>N</mi></msubsup><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>0</mn></mrow><annotation encoding="application/x-tex">\sum_{j=1}^N w_{ij} = 0</annotation></semantics></math>,
as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>w</mi><mrow><mi>i</mi><mi>j</mi></mrow></msub><mo>=</mo><mn>0</mn><mo>,</mo><mo>∀</mo><mi>j</mi></mrow><annotation encoding="application/x-tex">w_{ij} = 0, \forall j</annotation></semantics></math>
(see discussion in <span class="citation">Bivand and Portnov
(2004)</span>). Its eigenvalue will also be zero, with consequences for
analytical inference:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">$</span><span class="va">values</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0</span></span></code></pre>
<p>The <code>adjust.n</code> argument to measures of spatial
autocorrelation is by default TRUE, and subtracts the count of singleton
nodes from
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
in an attempt to acknowledge the reduction in information available.</p>
<p>This discussion will address problems arising when analysing
areal/lattice data, and neighbours are defined as polygon features with
contiguous boundaries. One way in which no-neighbour observations may
occur is when they are islands. This is clearly the case in <span class="citation">Freni-Sterrantino, Ventrucci, and Rue (2018)</span>,
where Capraia and Giglio Isles are singleton nodes. Here we take
Westminster constituencies for Wales used in the July 2024 UK general
election. If GDAL is at least version 3.7.0, the driver supports
compressed GeoPackage files, if not they must be decompressed first.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">GDAL37</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric_version.html" class="external-link">as.numeric_version</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/sf_extSoftVersion.html" class="external-link">sf_extSoftVersion</a></span><span class="op">(</span><span class="op">)</span><span class="op">[</span><span class="st">"GDAL"</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">&gt;=</span> <span class="st">"3.7.0"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>The boundaries are taken from the Ordnance Survey Boundary-Line site,
<a href="https://osdatahub.os.uk/downloads/open/BoundaryLine" class="external-link uri">https://osdatahub.os.uk/downloads/open/BoundaryLine</a>,
choosing the 2024 Westminster constituencies (<a href="https://www.os.uk/opendata/licence" class="external-link uri">https://www.os.uk/opendata/licence</a>), simplified using a
tolerance of 50m to reduce object size, and merged with selected voting
outcomes for constituencies in Great Britain <a href="https://electionresults.parliament.uk/countries/1" class="external-link uri">https://electionresults.parliament.uk/countries/1</a>, (<a href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/" class="external-link uri">https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/</a>).
Here, the subset for Wales is useful as we will see:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file</span> <span class="op">&lt;-</span> <span class="st">"etc/shapes/GB_2024_Wales_50m.gpkg.zip"</span></span>
<span><span class="va">zipfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="va">file</span>, package<span class="op">=</span><span class="st">"spdep"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">GDAL37</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">w50m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">zipfile</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">td</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">bn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">".zip"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span>, fixed<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/unzip.html" class="external-link">unzip</a></span><span class="op">(</span><span class="va">zipfile</span>, files<span class="op">=</span><span class="va">bn</span>, exdir<span class="op">=</span><span class="va">td</span><span class="op">)</span></span>
<span>    <span class="va">w50m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Reading layer `GB_2024_Wales_50m' from data source </span></span>
<span><span class="co">##   `/tmp/RtmpcuVtwS/temp_libpathba7861ea38876/spdep/etc/shapes/GB_2024_Wales_50m.gpkg.zip' </span></span>
<span><span class="co">##   using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 32 features and 19 fields</span></span>
<span><span class="co">## Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 146597.1 ymin: 164536.5 xmax: 355287 ymax: 395993.5</span></span>
<span><span class="co">## Projected CRS: OSGB36 / British National Grid</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">w50m</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span>row.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">$</span><span class="va">Constituency</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_W_50m</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in poly2nb(w50m, row.names = as.character(w50m$Constituency)): some observations have no neighbours;</span></span>
<span><span class="co">## if this seems unexpected, try increasing the snap argument.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in poly2nb(w50m, row.names = as.character(w50m$Constituency)): neighbour object has 2 sub-graphs;</span></span>
<span><span class="co">## if this sub-graph count seems unexpected, try increasing the snap argument.</span></span></code></pre>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 32 </span></span>
<span><span class="co">## Number of nonzero links: 136 </span></span>
<span><span class="co">## Percentage nonzero weights: 13.28125 </span></span>
<span><span class="co">## Average number of links: 4.25 </span></span>
<span><span class="co">## 1 region with no links:</span></span>
<span><span class="co">## Ynys Môn</span></span>
<span><span class="co">## 2 disjoint connected subgraphs</span></span></code></pre>
<p>The two subgraphs are the singleton Ynys Môn and all the other 31
constituencies:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_W_50m</span>, <span class="st">"ncomp"</span><span class="op">)</span><span class="op">$</span><span class="va">comp.id</span> <span class="op">|&gt;</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## </span></span>
<span><span class="co">##  1 31 </span></span>
<span><span class="co">##  1  1</span></span></code></pre>
<p>The left map shows that Ynys Môn can be shown selecting by name, as a
black border, and by the zero cardinality of its neighbour set, using
<code>card</code>, filling the polygon. The right map shows the location
of the island, known in English as Anglesey, north-west of the Welsh
mainland, and with no neighbour links:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ynys_mon</span> <span class="op">&lt;-</span> <span class="va">w50m</span><span class="op">$</span><span class="va">Constituency</span> <span class="op">==</span> <span class="st">"Ynys Môn"</span></span>
<span><span class="va">pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_point_on_surface</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">opar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span>mfrow<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">)</span>, border<span class="op">=</span><span class="st">"grey75"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">)</span><span class="op">[</span><span class="va">ynys_mon</span><span class="op">]</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="../reference/card.html">card</a></span><span class="op">(</span><span class="va">nb_W_50m</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0L</span><span class="op">]</span>, add<span class="op">=</span><span class="cn">TRUE</span>, border<span class="op">=</span><span class="st">"transparent"</span>, col<span class="op">=</span><span class="st">"wheat1"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">)</span>, border<span class="op">=</span><span class="st">"grey75"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nb_W_50m</span>, <span class="va">pts</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="subgraphs_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/par.html" class="external-link">par</a></span><span class="op">(</span><span class="va">opar</span><span class="op">)</span></span></code></pre></div>
<p>From the maps, we can see that the island is close to two
constituencies across the Afon Menai (Menai Strait in English), the
three simplified polygons being less than 280m apart, measured between
polygon boundaries:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dym</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_distance</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">[</span><span class="va">ynys_mon</span>,<span class="op">]</span>, <span class="va">w50m</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">dym</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Units: [m]</span></span>
<span><span class="co">##  [1]      0.0000    123.4132    277.5414  16658.7265  37985.7086  54096.7729</span></span>
<span><span class="co">##  [7]  58146.4320  65550.2491  67696.3323  93741.9873 113007.3659 137858.1826</span></span></code></pre>
<p>Using a <code>snap</code> distance of 280m, we can join the island to
its two obvious proximate neighbours:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_W_50m_snap</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">w50m</span>, row.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">$</span><span class="va">Constituency</span><span class="op">)</span>, snap<span class="op">=</span><span class="fl">280</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 32 </span></span>
<span><span class="co">## Number of nonzero links: 140 </span></span>
<span><span class="co">## Percentage nonzero weights: 13.67188 </span></span>
<span><span class="co">## Average number of links: 4.375</span></span></code></pre>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">)</span>, border<span class="op">=</span><span class="st">"grey75"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nb_W_50m_snap</span>, <span class="va">pts</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="subgraphs_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>In this case, increasing <code>snap</code> from its default of 10mm
(or close equivalents for geometries with known metrics; previously
<code>sqrt(.Machine$double.eps)</code> 1.4901161^{-8} in all cases)
helps. The symmetric links added are to:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_W_50m_snap</span>, <span class="st">"region.id"</span><span class="op">)</span><span class="op">[</span><span class="va">nb_W_50m_snap</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">ynys_mon</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Bangor Aberconwy"   "Dwyfor Meirionnydd"</span></span></code></pre>
<p>This is not always going to be the case, but here the strait is
narrow. If islands are much further offshore, other steps may be
required, because a large <code>snap</code> distance will draw in extra
neighbours for already connected observations. It is also possible that
increasing the <code>snap</code> distance may fail to link islands if
they are not considered candidate neighbours, that is if their extents
(bounding boxes), buffered out by the <code>snap</code> value, do not
intersect.</p>
<p>We can also use the distances to pick out those neighbour candidates
that meet our criterion of 280m, taking care not to lose the ordering
needed to identify the correct observations:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">meet_criterion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dym</span> <span class="op">&lt;=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">280</span>, <span class="st">"m"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 3</span></span></code></pre>
<p>These candidates are the island itself, and the two neighbours across
the Menai Strait:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">cands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_W_50m</span>, <span class="st">"region.id"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">dym</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">meet_criterion</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Ynys Môn"           "Bangor Aberconwy"   "Dwyfor Meirionnydd"</span></span></code></pre>
<p>The <code>addlinks1</code> function can be used to add both the links
from Ynys Môn to its neighbours, and by symmetry from them to Ynys Môn.
This approach means that each island should be treated separately (or
scripted in sequence), but does not risk adding spurious neighbours in
denser parts of the study area.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_W_50m_add</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/droplinks.html">addlinks1</a></span><span class="op">(</span><span class="va">nb_W_50m</span>, from <span class="op">=</span> <span class="va">cands</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, to <span class="op">=</span> <span class="va">cands</span><span class="op">[</span><span class="fl">2</span><span class="op">:</span><span class="va">meet_criterion</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 32 </span></span>
<span><span class="co">## Number of nonzero links: 140 </span></span>
<span><span class="co">## Percentage nonzero weights: 13.67188 </span></span>
<span><span class="co">## Average number of links: 4.375</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/all.equal.html" class="external-link">all.equal</a></span><span class="op">(</span><span class="va">nb_W_50m_add</span>, <span class="va">nb_W_50m_snap</span>, check.attributes<span class="op">=</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>Since these constituency observations have areal support, it is not
surprising that changing support to points and using
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>k</mi><annotation encoding="application/x-tex">k</annotation></semantics></math>-nearest
neighbours does not work adequately, because the distance measurements
are between the points representing the polygons rather than as above
between the areal unit boundaries:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">k2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="fu"><a href="../reference/knearneigh.html">knearneigh</a></span><span class="op">(</span><span class="va">pts</span>, k<span class="op">=</span><span class="fl">2</span><span class="op">)</span>, row.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">$</span><span class="va">Constituency</span><span class="op">)</span>, sym<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in knn2nb(knearneigh(pts, k = 2), row.names =</span></span>
<span><span class="co">## as.character(w50m$Constituency), : neighbour object has 2 sub-graphs</span></span></code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">k2</span>, <span class="st">"region.id"</span><span class="op">)</span><span class="op">[</span><span class="va">k2</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">ynys_mon</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Bangor Aberconwy" "Clwyd North"</span></span></code></pre>
<p>Here, Clwyd North, east of Bangor Aberconwy, is given as a neighbour
of Ynys Môn but Dwyfor Meirionnydd, west of Bangor Aberconwy, is not. In
addition, there are two subgraphs, which still remain up to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>k</mi><mo>=</mo><mn>6</mn></mrow><annotation encoding="application/x-tex">k=6</annotation></semantics></math>.</p>
</div>
<div class="section level2">
<h2 id="subgraphs">Subgraphs<a class="anchor" aria-label="anchor" href="#subgraphs"></a>
</h2>
<p>Subgraphs may be found when no-neighbour observations are present,
but also when the graph is split between two blocks of observations with
no path from any observation in a block to any in another block, across
the low population density constituencies in mid-Wales:</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">k6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="fu"><a href="../reference/knearneigh.html">knearneigh</a></span><span class="op">(</span><span class="va">pts</span>, k<span class="op">=</span><span class="fl">6</span><span class="op">)</span>, row.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">$</span><span class="va">Constituency</span><span class="op">)</span>, sym<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in knn2nb(knearneigh(pts, k = 6), row.names =</span></span>
<span><span class="co">## as.character(w50m$Constituency), : neighbour object has 2 sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 32 </span></span>
<span><span class="co">## Number of nonzero links: 238 </span></span>
<span><span class="co">## Percentage nonzero weights: 23.24219 </span></span>
<span><span class="co">## Average number of links: 7.4375 </span></span>
<span><span class="co">## 2 disjoint connected subgraphs</span></span></code></pre>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">)</span>, border<span class="op">=</span><span class="st">"grey75"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">k6</span>, <span class="va">pts</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="subgraphs_files/figure-html/unnamed-chunk-18-1.png" width="700">
We can show the block structure by displaying the binary spatial weights
matrix:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">o</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">k6</span>, <span class="st">"ncomp"</span><span class="op">)</span><span class="op">$</span><span class="va">comp.id</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/image.html" class="external-link">image</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/transpose.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="../reference/nb2mat.html">nb2mat</a></span><span class="op">(</span><span class="va">k6</span>, style<span class="op">=</span><span class="st">"B"</span><span class="op">)</span><span class="op">[</span><span class="va">o</span>, <span class="fu"><a href="https://rspatial.github.io/terra/reference/flip.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">o</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, axes<span class="op">=</span><span class="cn">FALSE</span>, asp<span class="op">=</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p><img src="subgraphs_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>This occurs frequently with point support, but may also occur with
areal support, as <span class="citation">Freni-Sterrantino, Ventrucci,
and Rue (2018)</span> find for the eight municipalities on the island of
Elba.</p>
<p>From <code>spdep</code> 1.3-6, if the <code>igraph</code> and
<code>spatialreg</code> packages are available, <code>n.comp.nb</code>
uses <code><a href="https://r.igraph.org/reference/components.html" class="external-link">igraph::components</a></code> to compute the graph components,
also using depth-first search. The original implementation is as fast,
but for directed (asymmetric) graphs converts first to symmetry, while
<code><a href="https://r.igraph.org/reference/components.html" class="external-link">igraph::components</a></code> can handle directed graphs without such
conversion (see <a href="https://github.com/r-spatial/spdep/issues/160" class="external-link uri">https://github.com/r-spatial/spdep/issues/160</a> for
details).</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">k6a</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/knn2nb.html">knn2nb</a></span><span class="op">(</span><span class="fu"><a href="../reference/knearneigh.html">knearneigh</a></span><span class="op">(</span><span class="va">pts</span>, k<span class="op">=</span><span class="fl">6</span><span class="op">)</span>, row.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">$</span><span class="va">Constituency</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in knn2nb(knearneigh(pts, k = 6), row.names =</span></span>
<span><span class="co">## as.character(w50m$Constituency)): neighbour object has 2 sub-graphs</span></span></code></pre>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 32 </span></span>
<span><span class="co">## Number of nonzero links: 192 </span></span>
<span><span class="co">## Percentage nonzero weights: 18.75 </span></span>
<span><span class="co">## Average number of links: 6 </span></span>
<span><span class="co">## 2 disjoint connected subgraphs</span></span>
<span><span class="co">## Non-symmetric neighbours list</span></span></code></pre>
<p>Another case demonstrates how cyclical subgraphs may appear; this is
again taken from constituencies in the 2024 UK general election,
subsetted to those in England south of London.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file</span> <span class="op">&lt;-</span> <span class="st">"etc/shapes/GB_2024_southcoast_50m.gpkg.zip"</span></span>
<span><span class="va">zipfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="va">file</span>, package<span class="op">=</span><span class="st">"spdep"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">GDAL37</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">sc50m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">zipfile</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">td</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">bn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">".zip"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span>, fixed<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/unzip.html" class="external-link">unzip</a></span><span class="op">(</span><span class="va">zipfile</span>, files<span class="op">=</span><span class="va">bn</span>, exdir<span class="op">=</span><span class="va">td</span><span class="op">)</span></span>
<span>    <span class="va">sc50m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Reading layer `GB_2024_southcoast_50m' from data source </span></span>
<span><span class="co">##   `/tmp/RtmpcuVtwS/temp_libpathba7861ea38876/spdep/etc/shapes/GB_2024_southcoast_50m.gpkg.zip' </span></span>
<span><span class="co">##   using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 119 features and 19 fields</span></span>
<span><span class="co">## Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 82643.12 ymin: 5342.9 xmax: 640301.6 ymax: 187226.2</span></span>
<span><span class="co">## Projected CRS: OSGB36 / British National Grid</span></span></code></pre>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_sc_50m</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">sc50m</span>, row.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">sc50m</span><span class="op">$</span><span class="va">Constituency</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in poly2nb(sc50m, row.names = as.character(sc50m$Constituency)): neighbour object has 2 sub-graphs;</span></span>
<span><span class="co">## if this sub-graph count seems unexpected, try increasing the snap argument.</span></span></code></pre>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 119 </span></span>
<span><span class="co">## Number of nonzero links: 530 </span></span>
<span><span class="co">## Percentage nonzero weights: 3.742674 </span></span>
<span><span class="co">## Average number of links: 4.453782 </span></span>
<span><span class="co">## 2 disjoint connected subgraphs</span></span></code></pre>
<p>The second subgraph only has two members, who are each others’ only
neighbours, known as a cyclical component.</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">nc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_sc_50m</span>, <span class="st">"ncomp"</span><span class="op">)</span><span class="op">$</span><span class="va">comp.id</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">nc</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## nc</span></span>
<span><span class="co">##   1   2 </span></span>
<span><span class="co">## 117   2</span></span></code></pre>
<p>Both constituencies are on the Isle of Wight:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">sub2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_sc_50m</span>, <span class="st">"region.id"</span><span class="op">)</span><span class="op">[</span><span class="va">nc</span> <span class="op">==</span> <span class="fl">2L</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Isle of Wight East" "Isle of Wight West"</span></span></code></pre>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_point_on_surface</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">sc50m</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">sc50m</span><span class="op">)</span>, border<span class="op">=</span><span class="st">"grey75"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">sc50m</span><span class="op">)</span><span class="op">[</span><span class="va">nc</span> <span class="op">==</span> <span class="fl">2L</span><span class="op">]</span>, border<span class="op">=</span><span class="st">"orange"</span>, lwd<span class="op">=</span><span class="fl">2</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nb_sc_50m</span>, <span class="va">pts</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="subgraphs_files/figure-html/unnamed-chunk-25-1.png" width="700"></p>
<p>This has consequences for the eigenvalues of the spatial weights
matrix, pointed out by <span class="citation">Smirnov and Anselin
(2009)</span> and <span class="citation">Bivand, Hauke, and Kossowski
(2013)</span>. With row-standardised weights, the eigenvalues of this
component are:</p>
<div class="sourceCode" id="cb58"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1  1</span></span></code></pre>
<div class="sourceCode" id="cb60"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="fu"><a href="../reference/nb2mat.html">nb2mat</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">nb_sc_50m</span>, <span class="va">nc</span> <span class="op">==</span> <span class="fl">2L</span><span class="op">)</span>, style<span class="op">=</span><span class="st">"W"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1  1</span></span></code></pre>
<p>This “takes over” the lower domain boundary, which for the whole data
set is now the same:</p>
<div class="sourceCode" id="cb62"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="fu"><a href="../reference/nb2mat.html">nb2mat</a></span><span class="op">(</span><span class="va">nb_sc_50m</span>, style<span class="op">=</span><span class="st">"W"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1  1</span></span></code></pre>
<p>compared to the lower domain boundary for the remainder of the study
area:</p>
<div class="sourceCode" id="cb64"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fl">1</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/range.html" class="external-link">range</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/eigen.html" class="external-link">eigen</a></span><span class="op">(</span><span class="fu"><a href="../reference/nb2mat.html">nb2mat</a></span><span class="op">(</span><span class="fu"><a href="https://rspatial.github.io/terra/reference/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">nb_sc_50m</span>, <span class="va">nc</span> <span class="op">==</span> <span class="fl">1L</span><span class="op">)</span>, style<span class="op">=</span><span class="st">"W"</span><span class="op">)</span><span class="op">)</span><span class="op">$</span><span class="va">values</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] -1.094637  1.000000</span></span></code></pre>
<p>This subgraph may be added to the remainder as shown above:</p>
<div class="sourceCode" id="cb66"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">iowe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">sub2</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_sc_50m</span>, <span class="st">"region.id"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">diowe</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_distance</a></span><span class="op">(</span><span class="va">sc50m</span><span class="op">[</span><span class="va">iowe</span>,<span class="op">]</span>, <span class="va">sc50m</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">diowe</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Units: [m]</span></span>
<span><span class="co">##  [1]     0.000     0.000  1886.833  3509.366  6693.575  6943.672  7678.999</span></span>
<span><span class="co">##  [8]  8576.454 10579.530 12163.332 16875.920 17161.786</span></span></code></pre>
<div class="sourceCode" id="cb68"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ioww</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rspatial.github.io/terra/reference/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">sub2</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_sc_50m</span>, <span class="st">"region.id"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dioww</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_measures.html" class="external-link">st_distance</a></span><span class="op">(</span><span class="va">sc50m</span><span class="op">[</span><span class="va">ioww</span>,<span class="op">]</span>, <span class="va">sc50m</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="va">dioww</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">12</span><span class="op">]</span></span></code></pre></div>
<pre><code><span><span class="co">## Units: [m]</span></span>
<span><span class="co">##  [1]     0.000     0.000  1232.724  2541.318  5746.764  5770.602  8902.579</span></span>
<span><span class="co">##  [8]  9747.265 10529.540 10909.845 12250.564 12379.871</span></span></code></pre>
<p>Using 5km as a cutoff seems prudent, but would not work as a
<code>snap</code> value. Taking Isle of Wight East first, there are four
constituencies with boundaries within 5km:</p>
<div class="sourceCode" id="cb70"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">meet_criterion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">diowe</span> <span class="op">&lt;=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">5000</span>, <span class="st">"m"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 4</span></span></code></pre>
<p>Obviously the contiguous neighbour is among them with zero distance,
and needs to be dropped, although <code>addlinks1</code> would drop the
duplicate:</p>
<div class="sourceCode" id="cb72"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">cands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_sc_50m</span>, <span class="st">"region.id"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">diowe</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">meet_criterion</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Isle of Wight East" "Isle of Wight West" "Portsmouth South"  </span></span>
<span><span class="co">## [4] "Gosport"</span></span></code></pre>
<div class="sourceCode" id="cb74"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_sc_50m_iowe</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/droplinks.html">addlinks1</a></span><span class="op">(</span><span class="va">nb_sc_50m</span>, from <span class="op">=</span> <span class="va">cands</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, to <span class="op">=</span> <span class="va">cands</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="va">meet_criterion</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 119 </span></span>
<span><span class="co">## Number of nonzero links: 534 </span></span>
<span><span class="co">## Percentage nonzero weights: 3.77092 </span></span>
<span><span class="co">## Average number of links: 4.487395</span></span></code></pre>
<p>Although all constituencies are now linked, we should see whether
using the 5km criterion brings in extra neighbours for Isle of Wight
West:</p>
<div class="sourceCode" id="cb76"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">meet_criterion</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">dioww</span> <span class="op">&lt;=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fl">5000</span>, <span class="st">"m"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 4</span></span></code></pre>
<p>It, does, but we need to beware of the sorting order of the zero
self-distance and contiguous neighbour distance, where <code>from</code>
is now in the second position:</p>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">cands</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_sc_50m</span>, <span class="st">"region.id"</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">dioww</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="va">meet_criterion</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "Isle of Wight East" "Isle of Wight West" "New Forest West"   </span></span>
<span><span class="co">## [4] "New Forest East"</span></span></code></pre>
<p>This then yields links to the north-west:</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_sc_50m_iow</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/droplinks.html">addlinks1</a></span><span class="op">(</span><span class="va">nb_sc_50m_iowe</span>, from <span class="op">=</span> <span class="va">cands</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, to <span class="op">=</span> <span class="va">cands</span><span class="op">[</span><span class="fl">3</span><span class="op">:</span><span class="va">meet_criterion</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 119 </span></span>
<span><span class="co">## Number of nonzero links: 538 </span></span>
<span><span class="co">## Percentage nonzero weights: 3.799167 </span></span>
<span><span class="co">## Average number of links: 4.521008</span></span></code></pre>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html" class="external-link">st_point_on_surface</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">sc50m</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">sc50m</span><span class="op">)</span>, border<span class="op">=</span><span class="st">"grey75"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_geometry.html" class="external-link">st_geometry</a></span><span class="op">(</span><span class="va">sc50m</span><span class="op">)</span><span class="op">[</span><span class="va">nc</span> <span class="op">==</span> <span class="fl">2L</span><span class="op">]</span>, border<span class="op">=</span><span class="st">"orange"</span>, lwd<span class="op">=</span><span class="fl">2</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rspatial.github.io/terra/reference/plot.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">nb_sc_50m_iow</span>, <span class="va">pts</span>, add<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="subgraphs_files/figure-html/unnamed-chunk-37-1.png" width="700"></p>
<p>It remains to add a suitable generalisation of <code>addlinks1</code>
to handle a <code>from</code> vector argument and a <code>to</code>
argument taking a list of vectors.</p>
</div>
<div class="section level2">
<h2 id="per-session-control-of-function-behaviour">Per-session control of function behaviour<a class="anchor" aria-label="anchor" href="#per-session-control-of-function-behaviour"></a>
</h2>
<p>From very early on, the default value of the <code>zero.policy</code>
argument to many methods and functions was <code>NULL</code>. If the
value was <code>NULL</code>, <code>zero.policy</code> would be set from
<code>get.ZeroPolicyOption</code>:</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set.spChkOption.html">get.ZeroPolicyOption</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
<p>On loading <code>spdep</code>, the internal option is set to
<code>FALSE</code>, so functions and methods using
<code>zero.policy</code> need to choose how to handle islands:</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="../reference/nb2listw.html">nb2listw</a></span><span class="op">(</span><span class="va">nb_W_50m</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error in nb2listw(nb_W_50m) : </span></span>
<span><span class="co">##   Empty neighbour sets found (zero.policy: FALSE)</span></span></code></pre>
<p>In this case, it was shown above how the island may reasonably be
associated with proximate constituencies on the mainland. If, however,
the user wishes to override the default,
<code>set.ZeroPolicyOption</code> may be used to set a different
per-session default:</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set.spChkOption.html">set.ZeroPolicyOption</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set.spChkOption.html">get.ZeroPolicyOption</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">lw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/nb2listw.html">nb2listw</a></span><span class="op">(</span><span class="va">nb_W_50m</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Characteristics of weights list object:</span></span>
<span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 32 </span></span>
<span><span class="co">## Number of nonzero links: 136 </span></span>
<span><span class="co">## Percentage nonzero weights: 13.28125 </span></span>
<span><span class="co">## Average number of links: 4.25 </span></span>
<span><span class="co">## 1 region with no links:</span></span>
<span><span class="co">## Ynys Môn</span></span>
<span><span class="co">## 2 disjoint connected subgraphs</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Weights style: W </span></span>
<span><span class="co">## Weights constants summary:</span></span>
<span><span class="co">##    n  nn S0       S1      S2</span></span>
<span><span class="co">## W 31 961 31 15.36355 129.051</span></span></code></pre>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">lw</span>, <span class="st">"zero.policy"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set.spChkOption.html">set.ZeroPolicyOption</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>When a <code>listw</code> object is created with
<code>zero.policy</code> set to <code>TRUE</code>, this choice is added
to the output object as an attribute and applied when the object is used
(unless specifically overridden). Note also above that while there are
32 constituencies, the observation count reported by
<code>spweights.constants</code> called by the <code>print</code> method
for <code>listw</code> object has argument <code>adjust.n</code> TRUE,
dropping no-neighbour observations from the observation count.</p>
<p>Other internal options have been introduced to suppress no-neighbour
and subgraph warnings when creating <code>nb</code> objects. The default
values are as follows:</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set.spChkOption.html">get.NoNeighbourOption</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set.spChkOption.html">get.SubgraphOption</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set.spChkOption.html">get.SubgraphCeiling</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 100000</span></span></code></pre>
<p><code>get.NoNeighbourOption</code> controls the issuing of warnings
when <code>nb</code> objects are created with no-neighbour observations;
<code>get.SubgraphOption</code> works similarly but for warnings issued
when there is more than one graph component; both are TRUE by default.
<code>get.SubgraphCeiling</code> sets the integer value of graph nodes
plus graph edges above which calculating on the graph is considered too
costly in compute time, the default is 100,000. This corresponds to a
dense neighbour set with just over 300 nodes (with almost 100000 edges)
such as that needed to use inverse distance weights, or just over 14,000
nodes with an average neighbour count of 6.</p>
<p>The <code>print</code> method for <code>nb</code> objects reports
no-neighbour and subgraph status anyway, so careful users who always
examine generated objects may prefer to supress the warnings, but
warnings seem prudent when users may not examine the objects, or when
generation is by subsetting of larger objects, for example in the
creation of training and test data sets. Here the Welsh constituency
boundaries will be used to show the behaviour of the internal
options:</p>
<div class="sourceCode" id="cb101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set.spChkOption.html">set.NoNeighbourOption</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">w50m</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span>row.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">$</span><span class="va">Constituency</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_W_50mz</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in poly2nb(w50m, row.names = as.character(w50m$Constituency)): neighbour object has 2 sub-graphs;</span></span>
<span><span class="co">## if this sub-graph count seems unexpected, try increasing the snap argument.</span></span></code></pre>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 32 </span></span>
<span><span class="co">## Number of nonzero links: 136 </span></span>
<span><span class="co">## Percentage nonzero weights: 13.28125 </span></span>
<span><span class="co">## Average number of links: 4.25 </span></span>
<span><span class="co">## 1 region with no links:</span></span>
<span><span class="co">## Ynys Môn</span></span>
<span><span class="co">## 2 disjoint connected subgraphs</span></span></code></pre>
<p>Turning both off removes the warnings:</p>
<div class="sourceCode" id="cb104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set.spChkOption.html">set.SubgraphOption</a></span><span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">w50m</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span>row.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">$</span><span class="va">Constituency</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_W_50my</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 32 </span></span>
<span><span class="co">## Number of nonzero links: 136 </span></span>
<span><span class="co">## Percentage nonzero weights: 13.28125 </span></span>
<span><span class="co">## Average number of links: 4.25 </span></span>
<span><span class="co">## 1 region with no links:</span></span>
<span><span class="co">## Ynys Môn</span></span></code></pre>
<p>When <code>get.SubgraphOption</code> is FALSE, the attribute
containing the output of <code>n.comp.nb</code> is not added:</p>
<div class="sourceCode" id="cb106"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_W_50my</span>, <span class="st">"ncomp"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  NULL</span></span></code></pre>
<p>The reduction of the ceiling to below node count 32 plus edge count
136 also supresses the calculation of graph components:</p>
<div class="sourceCode" id="cb108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set.spChkOption.html">set.SubgraphOption</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/set.spChkOption.html">set.SubgraphCeiling</a></span><span class="op">(</span><span class="fl">100L</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">w50m</span> <span class="op">|&gt;</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span>row.names<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">w50m</span><span class="op">$</span><span class="va">Constituency</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">nb_W_50mx</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 32 </span></span>
<span><span class="co">## Number of nonzero links: 136 </span></span>
<span><span class="co">## Percentage nonzero weights: 13.28125 </span></span>
<span><span class="co">## Average number of links: 4.25 </span></span>
<span><span class="co">## 1 region with no links:</span></span>
<span><span class="co">## Ynys Môn</span></span></code></pre>
<div class="sourceCode" id="cb110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_W_50mx</span>, <span class="st">"ncomp"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  NULL</span></span></code></pre>
<p>Restoring the remaining default values:</p>
<div class="sourceCode" id="cb112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/set.spChkOption.html">set.SubgraphCeiling</a></span><span class="op">(</span><span class="fl">100000L</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/set.spChkOption.html">set.NoNeighbourOption</a></span><span class="op">(</span><span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="unintentional-disconnected-graphs">Unintentional disconnected graphs<a class="anchor" aria-label="anchor" href="#unintentional-disconnected-graphs"></a>
</h2>
<p>Sometimes apparently sensible polygons turn out to be represented in
such a way that disconnected graphs are generated when extracting
contiguities. One such case was raised in <a href="https://github.com/r-spatial/spdep/issues/162" class="external-link uri">https://github.com/r-spatial/spdep/issues/162</a>, for
subdivisions of Tokyo. The original data file <code>tokyomet262.*</code>
from <a href="https://sgsup.asu.edu/sites/default/files/SparcFiles/tokyo_0.zip" class="external-link uri">https://sgsup.asu.edu/sites/default/files/SparcFiles/tokyo_0.zip</a>
was created some twenty years ago by Tomoki Nakaya and Martin Charlton,
and some geometry issues were known at the time. A possibility that may
affect legacy files is projection of geometries on 32-bit platforms, but
it is not known whether this affected this file. Here it has been
re-packaged as a compressed GeoPackage:</p>
<div class="sourceCode" id="cb113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">file</span> <span class="op">&lt;-</span> <span class="st">"etc/shapes/tokyo.gpkg.zip"</span></span>
<span><span class="va">zipfile</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="va">file</span>, package<span class="op">=</span><span class="st">"spdep"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="va">GDAL37</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">tokyo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">zipfile</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">td</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempdir</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="va">bn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">sub</a></span><span class="op">(</span><span class="st">".zip"</span>, <span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/basename.html" class="external-link">basename</a></span><span class="op">(</span><span class="va">file</span><span class="op">)</span>, fixed<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span>    <span class="va">target</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/unzip.html" class="external-link">unzip</a></span><span class="op">(</span><span class="va">zipfile</span>, files<span class="op">=</span><span class="va">bn</span>, exdir<span class="op">=</span><span class="va">td</span><span class="op">)</span></span>
<span>    <span class="va">tokyo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">st_read</a></span><span class="op">(</span><span class="va">target</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Reading layer `tokyo' from data source </span></span>
<span><span class="co">##   `/tmp/RtmpcuVtwS/temp_libpathba7861ea38876/spdep/etc/shapes/tokyo.gpkg.zip' </span></span>
<span><span class="co">##   using driver `GPKG'</span></span>
<span><span class="co">## Simple feature collection with 262 features and 3 fields</span></span>
<span><span class="co">## Geometry type: MULTIPOLYGON</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 266206.6 ymin: -90932.11 xmax: 411400.3 ymax: 37142.75</span></span>
<span><span class="co">## Projected CRS: Tokyo / Japan Plane Rectangular CS VI</span></span></code></pre>
<p>After correcting invalid polygons:</p>
<div class="sourceCode" id="cb115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_is_valid</a></span><span class="op">(</span><span class="va">tokyo</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tokyo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/valid.html" class="external-link">st_make_valid</a></span><span class="op">(</span><span class="va">tokyo</span><span class="op">)</span></span></code></pre></div>
<p>applying <code>poly2nb</code> with the legacy default snap value
produced numerous singleton observations as well as many
multiple-observation subgraphs:</p>
<div class="sourceCode" id="cb118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_t0</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">tokyo</span>, snap<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">.Machine</span><span class="op">$</span><span class="va">double.eps</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in poly2nb(tokyo, snap = sqrt(.Machine$double.eps)): some observations have no neighbours;</span></span>
<span><span class="co">## if this seems unexpected, try increasing the snap argument.</span></span></code></pre>
<pre><code><span><span class="co">## Warning in poly2nb(tokyo, snap = sqrt(.Machine$double.eps)): neighbour object has 23 sub-graphs;</span></span>
<span><span class="co">## if this sub-graph count seems unexpected, try increasing the snap argument.</span></span></code></pre>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 262 </span></span>
<span><span class="co">## Number of nonzero links: 946 </span></span>
<span><span class="co">## Percentage nonzero weights: 1.378125 </span></span>
<span><span class="co">## Average number of links: 3.610687 </span></span>
<span><span class="co">## 10 regions with no links:</span></span>
<span><span class="co">## 101, 127, 134, 135, 152, 154, 167, 237, 242, 243</span></span>
<span><span class="co">## 23 disjoint connected subgraphs</span></span></code></pre>
<p>The legacy default <code>snap</code> value when the coordinates are
measured in metres was 15 nanometres, which effectively assumed that the
coordinates making up polygon boundaries were identical:</p>
<div class="sourceCode" id="cb122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_t0</span>, <span class="st">"snap"</span><span class="op">)</span>, <span class="st">"m"</span><span class="op">)</span>, <span class="st">"nm"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 14.90116 [nm]</span></span></code></pre>
<p>Stepping out a little to 2mm, the lack of contact ceased to be a
problem.</p>
<div class="sourceCode" id="cb124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_t1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">tokyo</span>, snap<span class="op">=</span><span class="fl">0.002</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 262 </span></span>
<span><span class="co">## Number of nonzero links: 1390 </span></span>
<span><span class="co">## Percentage nonzero weights: 2.02494 </span></span>
<span><span class="co">## Average number of links: 5.305344</span></span></code></pre>
<div class="sourceCode" id="cb126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_t1</span>, <span class="st">"snap"</span><span class="op">)</span>, <span class="st">"m"</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 2 [mm]</span></span></code></pre>
<p>On that basis, the default was changed from <code>spdep</code> 1.3-6
to 10mm for projected polygons, and the snap value used was returned as
an attribute of the neighbour object:</p>
<div class="sourceCode" id="cb128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_t2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="va">tokyo</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 262 </span></span>
<span><span class="co">## Number of nonzero links: 1390 </span></span>
<span><span class="co">## Percentage nonzero weights: 2.02494 </span></span>
<span><span class="co">## Average number of links: 5.305344</span></span></code></pre>
<div class="sourceCode" id="cb130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://r-quantities.github.io/units/reference/units.html" class="external-link">set_units</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_t2</span>, <span class="st">"snap"</span><span class="op">)</span>, <span class="st">"m"</span><span class="op">)</span>, <span class="st">"mm"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## 10 [mm]</span></span></code></pre>
<p>Where the polygons are represented by geographical (spherical)
coordinates, the new default from <code>spdep</code> 1.3-6 is set to a
value mimicking 10mm:</p>
<div class="sourceCode" id="cb132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">nb_t3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/poly2nb.html">poly2nb</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html" class="external-link">st_transform</a></span><span class="op">(</span><span class="va">tokyo</span>, <span class="st">"OGC:CRS84"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Neighbour list object:</span></span>
<span><span class="co">## Number of regions: 262 </span></span>
<span><span class="co">## Number of nonzero links: 1336 </span></span>
<span><span class="co">## Percentage nonzero weights: 1.946274 </span></span>
<span><span class="co">## Average number of links: 5.099237</span></span></code></pre>
<p>The default <code>snap</code> value used in <code>poly2nb</code> when
the polygons are expressed in decimal degrees is:</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">nb_t3</span>, <span class="st">"snap"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 9e-08</span></span></code></pre>
<p>This was set based on the apparent “size” of 10mm in decimal
degrees:</p>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="fl">180</span> <span class="op">*</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">/</span> <span class="op">(</span><span class="va">pi</span> <span class="op">*</span> <span class="fl">6378137</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 8.983153e-08</span></span></code></pre>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-bivandetal13" class="csl-entry">
Bivand, Roger, Jan Hauke, and Tomasz Kossowski. 2013. <span>“Computing
the <span>J</span>acobian in <span>G</span>aussian Spatial
Autoregressive Models: An Illustrated Comparison of Available
Methods.”</span> <em>Geographical Analysis</em> 45 (2): 150–79. <a href="https://doi.org/10.1111/gean.12008" class="external-link">https://doi.org/10.1111/gean.12008</a>.
</div>
<div id="ref-bivand+portnov:04" class="csl-entry">
Bivand, Roger, and B. A. Portnov. 2004. <span>“Exploring Spatial Data
Analysis Techniques Using <span>R</span>: The Case of Observations with
No Neighbours.”</span> In <em>Advances in Spatial Econometrics:
Methodology, Tools, Applications</em>, edited by Luc Anselin, Raymond J.
G. M. Florax, and S. J. Rey, 121–42. Berlin: Springer. <a href="https://doi.org/10.1007/978-3-662-05617-2_6" class="external-link">https://doi.org/10.1007/978-3-662-05617-2_6</a>.
</div>
<div id="ref-FRENISTERRANTINO201825" class="csl-entry">
Freni-Sterrantino, Anna, Massimo Ventrucci, and Håvard Rue. 2018.
<span>“A Note on Intrinsic Conditional Autoregressive Models for
Disconnected Graphs.”</span> <em>Spatial and Spatio-Temporal
Epidemiology</em> 26: 25–34. <a href="https://doi.org/10.1016/j.sste.2018.04.002" class="external-link">https://doi.org/10.1016/j.sste.2018.04.002</a>.
</div>
<div id="ref-smirnov+anselin:09" class="csl-entry">
Smirnov, O., and L. Anselin. 2009. <span>“An <span>O(N)</span> Parallel
Method of Computing the <span>L</span>og-<span>J</span>acobian of the
Variable Transformation for Models with Spatial Interaction on a
Lattice.”</span> <em>Computational Statistics &amp; Data Analysis</em>
53 (8): 2980–88. <a href="https://doi.org/10.1016/j.csda.2008.10.010" class="external-link">https://doi.org/10.1016/j.csda.2008.10.010</a>.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Roger Bivand.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
